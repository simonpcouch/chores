<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>The testthat helper — testthat_helper • chores</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="The testthat helper — testthat_helper"><meta name="description" content="testthat 3.0.0 was released in 2020, bringing with it numerous changes
that were both huge quality of life improvements for package developers
and also highly breaking changes.
While some of the task of converting legacy unit testing code to testthat
3e is quite is pretty straightforward, other components can be quite tedious.
The testthat helper helps you transition your R package's unit tests to
the third edition of testthat, namely via:
Converting to snapshot tests
Disentangling nested expectations
Transitioning from deprecated functions like expect_known_*()

"><meta property="og:description" content="testthat 3.0.0 was released in 2020, bringing with it numerous changes
that were both huge quality of life improvements for package developers
and also highly breaking changes.
While some of the task of converting legacy unit testing code to testthat
3e is quite is pretty straightforward, other components can be quite tedious.
The testthat helper helps you transition your R package's unit tests to
the third edition of testthat, namely via:
Converting to snapshot tests
Disentangling nested expectations
Transitioning from deprecated functions like expect_known_*()

"><meta property="og:image" content="https://simonpcouch.github.io/chores/logo.png"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">chores</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.4</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../articles/chores.html">Get started</a></li>
<li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/custom.html">Custom helpers</a></li>
    <li><a class="dropdown-item" href="../articles/gallery.html">Gallery</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/simonpcouch/chores/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>The testthat helper</h1>
      <small class="dont-index">Source: <a href="https://github.com/simonpcouch/chores/blob/main/R/doc-helper-testthat.R" class="external-link"><code>R/doc-helper-testthat.R</code></a></small>
      <div class="d-none name"><code>testthat_helper.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>testthat 3.0.0 was released in 2020, bringing with it numerous changes
that were both huge quality of life improvements for package developers
and also highly breaking changes.</p>
<p>While some of the task of converting legacy unit testing code to testthat
3e is quite is pretty straightforward, other components can be quite tedious.
The testthat helper helps you transition your R package's unit tests to
the third edition of testthat, namely via:</p><ul><li><p>Converting to snapshot tests</p></li>
<li><p>Disentangling nested expectations</p></li>
<li><p>Transitioning from deprecated functions like <code>expect_known_*()</code></p></li>
</ul></div>


    <div class="section level2">
    <h2 id="cost">Cost<a class="anchor" aria-label="anchor" href="#cost"></a></h2>



<p>The system prompt from a testthat helper includes something like 1,000 tokens.
Add in (a generous) 100 tokens for the code that's actually highlighted
and also sent off to the model and you're looking at 1,100 input tokens.
The model returns approximately the same number of output tokens as it
receives, so we'll call that 100 output tokens per refactor.</p>
<p>As of the time of writing (October 2024), the recommended chores model Claude
Sonnet 3.5 costs $3 per million input tokens and $15 per million output
tokens. So, using the recommended model,
<strong>testthat helpers cost around $4 for every 1,000 refactored pieces of code</strong>. GPT-4o
Mini, by contrast, doesn't tend to get many pieces of formatting right and
often fails to line-break properly, but <em>does</em> usually return syntactically
valid calls to testthat functions, and it would cost around
20 cents per 1,000 refactored pieces of code.</p>
    </div>
    <div class="section level2">
    <h2 id="gallery">Gallery<a class="anchor" aria-label="anchor" href="#gallery"></a></h2>



<p>This section includes a handful of examples
"<a href="https://github.com/tidymodels/broom/tree/7fa26488ab522bf577092e99aad1f2003f21b327/tests" class="external-link">from</a>
the <a href="https://github.com/tidymodels/tune/tree/f8d734ac0fa981fae3a87ed2871a46e9c40d509d/tests" class="external-link">wild</a>"
and are generated with the recommended model, Claude Sonnet 3.5.</p>
<p>Testthat helpers convert <code>expect_error()</code> (and <code>*_warning()</code> and <code>*_message()</code>
and <code>*_condition()</code>) calls to use <code>expect_snapshot()</code> when there's a
regular expression present:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="fu">expect_warning</span><span class="op">(</span></span>
<span>  <span class="fu">check_ellipses</span><span class="op">(</span><span class="st">"exponentiate"</span>, <span class="st">"tidy"</span>, <span class="st">"boop"</span>, exponentiate <span class="op">=</span> <span class="cn">TRUE</span>, quick <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  <span class="st">"\\`exponentiate\\` argument is not supported in the \\`tidy\\(\\)\\` method for \\`boop\\` objects"</span></span>
<span><span class="op">)</span></span></code></pre><p></p></div>
<p>Returns:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="fu">expect_snapshot</span><span class="op">(</span></span>
<span>  <span class="va">.res</span> <span class="op">&lt;-</span> <span class="fu">check_ellipses</span><span class="op">(</span></span>
<span>    <span class="st">"exponentiate"</span>, <span class="st">"tidy"</span>, <span class="st">"boop"</span>, exponentiate <span class="op">=</span> <span class="cn">TRUE</span>, quick <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre><p></p></div>
<p>Note, as well, that intermediate results are assigned to an object so as
not to be snapshotted when their contents weren't previously tests.</p>
<p>Another example with multiple, redudant calls:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">augment_error</span> <span class="op">&lt;-</span> <span class="st">"augment is only supported for fixest models estimated with feols, feglm, or femlm"</span></span>
<span><span class="fu">expect_error</span><span class="op">(</span><span class="fu">augment</span><span class="op">(</span><span class="va">res_fenegbin</span>, <span class="va">df</span><span class="op">)</span>, <span class="va">augment_error</span><span class="op">)</span></span>
<span><span class="fu">expect_error</span><span class="op">(</span><span class="fu">augment</span><span class="op">(</span><span class="va">res_feNmlm</span>, <span class="va">df</span><span class="op">)</span>, <span class="va">augment_error</span><span class="op">)</span></span>
<span><span class="fu">expect_error</span><span class="op">(</span><span class="fu">augment</span><span class="op">(</span><span class="va">res_fepois</span>, <span class="va">df</span><span class="op">)</span>, <span class="va">augment_error</span><span class="op">)</span></span></code></pre><p></p></div>
<p>Returns:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="fu">expect_snapshot</span><span class="op">(</span>error <span class="op">=</span> <span class="cn">TRUE</span>, <span class="fu">augment</span><span class="op">(</span><span class="va">res_fenegbin</span>, <span class="va">df</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">expect_snapshot</span><span class="op">(</span>error <span class="op">=</span> <span class="cn">TRUE</span>, <span class="fu">augment</span><span class="op">(</span><span class="va">res_feNmlm</span>, <span class="va">df</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">expect_snapshot</span><span class="op">(</span>error <span class="op">=</span> <span class="cn">TRUE</span>, <span class="fu">augment</span><span class="op">(</span><span class="va">res_fepois</span>, <span class="va">df</span><span class="op">)</span><span class="op">)</span></span></code></pre><p></p></div>
<p>They know about <code>regexp = NA</code>, which means "no error" (or warning, or message):</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="fu">expect_error</span><span class="op">(</span></span>
<span>  <span class="va">p4_b</span> <span class="op">&lt;-</span> <span class="fu">check_parameters</span><span class="op">(</span><span class="va">w4</span>, <span class="va">p4_a</span>, data <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span>,</span>
<span>  regex <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="op">)</span></span></code></pre><p></p></div>
<p>Returns:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="fu">expect_no_error</span><span class="op">(</span><span class="va">p4_b</span> <span class="op">&lt;-</span> <span class="fu">check_parameters</span><span class="op">(</span><span class="va">w4</span>, <span class="va">p4_a</span>, data <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span><span class="op">)</span></span></code></pre><p></p></div>
<p>They also know not to adjust calls to those condition expectations when
there's a <code>class</code> argument present (which usually means that one is
testing a condition from another package, which should be able to change
the wording of the message without consequence):</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="fu">expect_error</span><span class="op">(</span><span class="fu">tidy</span><span class="op">(</span><span class="va">pca</span>, matrix <span class="op">=</span> <span class="st">"u"</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"pca_error"</span><span class="op">)</span></span></code></pre><p></p></div>
<p>Returns:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="fu">expect_error</span><span class="op">(</span><span class="fu">tidy</span><span class="op">(</span><span class="va">pca</span>, matrix <span class="op">=</span> <span class="st">"u"</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"pca_error"</span><span class="op">)</span></span></code></pre><p></p></div>
<p>When converting non-erroring code, testthat helpers will assign intermediate
results so as not to snapshot both the result and the warning:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="fu">expect_warning</span><span class="op">(</span></span>
<span>  <span class="fu">tidy</span><span class="op">(</span><span class="va">fit</span>, robust <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  <span class="st">'"robust" argument has been deprecated'</span></span>
<span><span class="op">)</span></span></code></pre><p></p></div>
<p>Returns:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="fu">expect_snapshot</span><span class="op">(</span></span>
<span>  <span class="va">.res</span> <span class="op">&lt;-</span> <span class="fu">tidy</span><span class="op">(</span><span class="va">fit</span>, robust <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre><p></p></div>
<p>Nested expectations can generally be disentangled without issue:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="fu">expect_equal</span><span class="op">(</span></span>
<span>  <span class="fu">fit_resamples</span><span class="op">(</span><span class="fu">decision_tree</span><span class="op">(</span>cost_complexity <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="fu">bootstraps</span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu">expect_warning</span><span class="op">(</span><span class="fu">tune_grid</span><span class="op">(</span><span class="fu">decision_tree</span><span class="op">(</span>cost_complexity <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="fu">bootstraps</span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre><p></p></div>
<p>Returns:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="fu">expect_snapshot</span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">fit_resamples_result</span> <span class="op">&lt;-</span> <span class="fu">fit_resamples</span><span class="op">(</span><span class="fu">decision_tree</span><span class="op">(</span>cost_complexity <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>                                        <span class="fu">bootstraps</span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">tune_grid_result</span> <span class="op">&lt;-</span> <span class="fu">tune_grid</span><span class="op">(</span><span class="fu">decision_tree</span><span class="op">(</span>cost_complexity <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>                                <span class="fu">bootstraps</span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu">expect_equal</span><span class="op">(</span><span class="va">fit_resamples_result</span>, <span class="va">tune_grid_result</span><span class="op">)</span></span></code></pre><p></p></div>
<p>There are also a few edits the helper knows to make to third-edition code.
For example, it transitions <code>expect_snapshot_error()</code> and friends to
use <code>expect_snapshot(error = TRUE)</code> so that the error context is snapshotted
in addition to the message itself:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="fu">expect_snapshot_error</span><span class="op">(</span></span>
<span>  <span class="fu">fit_best</span><span class="op">(</span><span class="va">knn_pca_res</span>, parameters <span class="op">=</span> <span class="fu">tibble</span><span class="op">(</span>neighbors <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre><p></p></div>
<p>Returns:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="fu">expect_snapshot</span><span class="op">(</span></span>
<span>  error <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="fu">fit_best</span><span class="op">(</span><span class="va">knn_pca_res</span>, parameters <span class="op">=</span> <span class="fu">tibble</span><span class="op">(</span>neighbors <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre><p></p></div>
    </div>
    <div class="section level2">
    <h2 id="interfacing-manually-with-the-testthat-helper">Interfacing manually with the testthat helper<a class="anchor" aria-label="anchor" href="#interfacing-manually-with-the-testthat-helper"></a></h2>



<p>Chore helpers are typically interfaced with via the chores addin. To call the testthat
helper directly, use:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">helper_testthat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dot-init_helper.html">.init_helper</a></span><span class="op">(</span><span class="st">"testthat"</span><span class="op">)</span></span></code></pre><p></p></div>
<p>Then, to submit a query, run:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">helper_testthat</span><span class="op">$</span><span class="fu">chat</span><span class="op">(</span><span class="op">{</span><span class="va">x</span><span class="op">}</span><span class="op">)</span></span></code></pre><p></p></div>
    </div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Simon Couch, Posit Software, PBC.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

